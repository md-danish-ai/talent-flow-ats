name: Google Chat ‚Äì PR Review & Merge Notifications

on:
  pull_request:
    types: [opened, reopened, review_requested, closed]
    branches:
      - develop
      - main

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Notify Google Chat
        env:
          WEBHOOK_URL: ${{ secrets.GOOGLE_CHAT_WEBHOOK }}
        run: |
          ACTION="${{ github.event.action }}"
          REPO="${{ github.repository }}"
          ACTOR="${{ github.actor }}"
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          HEAD_BRANCH="${{ github.event.pull_request.head.ref }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          IS_MERGED="${{ github.event.pull_request.merged }}"

          ############################################
          # CASE 1: Reviewer added after PR creation
          ############################################
          if [[ "$ACTION" == "review_requested" ]]; then
            REVIEWER_EMAIL="${{ github.event.requested_reviewer.email }}"

            if [[ -n "$REVIEWER_EMAIL" && "$REVIEWER_EMAIL" != "null" ]]; then
              MESSAGE="üëã <users/${REVIEWER_EMAIL}>\n\nYou have been added as a *reviewer* for this PR.\nKindly review this PR as per your convenience üôè\n\nRepository: *${REPO}*\nFrom: *${HEAD_BRANCH}*\nTo: *${BASE_BRANCH}*\n\nReview PR: ${PR_URL}"

              curl -X POST \
                -H "Content-Type: application/json" \
                -d "{\"text\":\"$MESSAGE\"}" \
                $WEBHOOK_URL
            fi

            exit 0
          fi

          ############################################
          # CASE 2: PR created / reopened
          ############################################
          if [[ "$ACTION" == "opened" || "$ACTION" == "reopened" ]]; then
            REVIEWERS=""
            REVIEWER_EMAILS=$(echo '${{ toJson(github.event.pull_request.requested_reviewers) }}' | jq -r '.[].email')

            for email in $REVIEWER_EMAILS; do
              if [[ "$email" != "null" && -n "$email" ]]; then
                REVIEWERS+="<users/${email}> "
              fi
            done

            if [[ -z "$REVIEWERS" ]]; then
              REVIEWERS="‚ö†Ô∏è No reviewers assigned yet"
            fi

            MESSAGE="üëÄ *Pull Request Review Requested*\n\nRepository: *${REPO}*\nFrom: *${HEAD_BRANCH}*\nTo: *${BASE_BRANCH}*\nAuthor: *${ACTOR}*\n\n${REVIEWERS}\nReview PR: ${PR_URL}"

            curl -X POST \
              -H "Content-Type: application/json" \
              -d "{\"text\":\"$MESSAGE\"}" \
              $WEBHOOK_URL

            exit 0
          fi

          ############################################
          # CASE 3: PR merged
          ############################################
          if [[ "$ACTION" == "closed" && "$IS_MERGED" == "true" ]]; then
            MESSAGE="üöÄ *Pull Request Merged*\n\nRepository: *${REPO}*\nBranch: *${BASE_BRANCH}*\nMerged by: *${ACTOR}*\n\nPlease pull the latest changes and sync your local branch."

            curl -X POST \
              -H "Content-Type: application/json" \
              -d "{\"text\":\"$MESSAGE\"}" \
              $WEBHOOK_URL
          fi