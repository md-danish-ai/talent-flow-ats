name: CI Pipeline

on:
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - develop
      - main

jobs:
  backend-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      - name: Lint with ruff
        run: ruff check backend

  frontend-check:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

  pr-base-check:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Check PR branching constraints
        run: |
          BASE_BRANCH="${{ github.base_ref }}"
          HEAD_BRANCH="${{ github.head_ref }}"
          
          echo "PR Base: $BASE_BRANCH"
          echo "PR Head: $HEAD_BRANCH"
          
          # Rule 1: Only 'develop' can target 'main'
          if [[ "$BASE_BRANCH" == "main" ]] && [[ "$HEAD_BRANCH" != "develop" ]]; then
            echo "Error: Only the 'develop' branch can target 'main'. PRs from '$HEAD_BRANCH' are not allowed."
            exit 1
          fi
          
          # Rule 2: Feature/Fix branches must target 'develop'
          if [[ "$BASE_BRANCH" != "develop" ]] && [[ "$HEAD_BRANCH" =~ ^(feat/|feature/|fix/|hotfix/) ]]; then
            echo "Error: Pull requests from feature/fix branches must target the 'develop' branch, not '$BASE_BRANCH'."
            exit 1
          fi
          
          echo "Branching constraints satisfied."
